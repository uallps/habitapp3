name: Build and Test HabitApp

on:
  push:
    branches: [ "ismael" ]
  pull_request:
    branches: [ "ismael" ]
  workflow_dispatch:

jobs:
  lint:
    name: SwiftLint & Code Quality
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install SwiftLint
        run: brew install swiftlint

      - name: Run SwiftLint
        run: swiftlint lint HabitApp --strict || true

      - name: Check for TODO/FIXME
        run: |
          echo "TODO items found:"
          grep -r "TODO" HabitApp --include="*.swift" | head -20 || echo "No TODOs"
          echo ""
          echo "FIXME items found:"
          grep -r "FIXME" HabitApp --include="*.swift" | head -20 || echo "No FIXMEs"

  build:
    name: Build and Test HabitApp
    runs-on: macos-latest
    needs: lint
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Show Xcode version
        run: xcodebuild -version

      - name: Show available SDKs
        run: xcodebuild -showsdks

      - name: Build for iOS Simulator
        run: |
          xcodebuild clean build \
            -project HabitApp.xcodeproj \
            -scheme HabitApp \
            -sdk iphonesimulator \
            -destination generic/platform=iOS \
            -derivedDataPath ./DerivedData \
            IPHONEOS_DEPLOYMENT_TARGET=18.0 \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO 2>&1 | tee build.log
        continue-on-error: true

      - name: Show Build Errors
        if: always()
        run: |
          echo "Build Results:"
          if grep -q "error:" build.log; then
            echo "Compilation errors found:"
            grep -A 2 "error:" build.log | head -50
          else
            echo "Build completed"
          fi

      - name: Build for macOS
        run: |
          xcodebuild clean build \
            -project HabitApp.xcodeproj \
            -scheme HabitApp \
            -sdk macosx \
            -destination 'platform=macOS' \
            -derivedDataPath ./DerivedData \
            MACOSX_DEPLOYMENT_TARGET=15.0 \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO
        continue-on-error: true

      - name: Run Unit Tests (latest iOS simulator)
        run: |
          set -e
          echo "Detecting latest iOS simulator..."

          DEVICE_ID=$(
            xcrun simctl list devices available -j |
            python3 - << 'EOF'
              import json, sys

              data = json.load(sys.stdin)["devices"]

              candidates = []
              for runtime, devices in data.items():
                  if "iOS" not in runtime:
                      continue
                  for d in devices:
                      if d.get("isAvailable"):
                          candidates.append((runtime, d["udid"]))

              # sort by runtime version
              candidates.sort(key=lambda x: x[0])
              print(candidates[-1][1])
              EOF
          )

          echo "Using simulator UDID: $DEVICE_ID"

          xcodebuild test \
            -project HabitApp.xcodeproj \
            -scheme HabitApp \
            -destination "platform=iOS Simulator,id=$DEVICE_ID" \
            -derivedDataPath ./DerivedData \
            IPHONEOS_DEPLOYMENT_TARGET=18.0 \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            | xcpretty

      - name: Test Results Summary
        if: always()
        run: |
          echo "Test Results:"
          find ./DerivedData -name "*.xcresult" -type d || echo "No test results found"

          XCRESULT=$(find ./DerivedData -name "*.xcresult" -type d | head -n 1)
          if [ ! -z "$XCRESULT" ]; then
            xcrun xcresulttool get --path "$XCRESULT" --format json > test-results.json || true
            echo "Test results exported"
          fi

      - name: Code Quality Metrics
        run: |
          echo "Code Quality Report"
          echo "====================="
          SWIFT_FILES=$(find HabitApp -name "*.swift" -type f | wc -l)
          LOC=$(find HabitApp -name "*.swift" -type f -exec cat {} \; | wc -l)
          echo "Swift Files: $SWIFT_FILES"
          echo "Lines of Code: $LOC"
          echo "Avg lines per file: $((LOC / SWIFT_FILES))"
          echo ""
          echo "Architecture:"
          find HabitApp -type d -maxdepth 2 | grep -E "(Core|Features|Infraestructure|Application)" | sort
          echo ""
          echo "Feature Breakdown:"
          echo "Goals: $(find HabitApp/Features/Goals -name "*.swift" 2>/dev/null | wc -l) files"
          echo "DailyNotes: $(find HabitApp/Features/DailyNotes -name "*.swift" 2>/dev/null | wc -l) files"
          echo "Categories: $(find HabitApp/Features/Categories -name "*.swift" 2>/dev/null | wc -l) files"
          echo "Statistics: $(find HabitApp/Features/Statistics -name "*.swift" 2>/dev/null | wc -l) files"
          echo "Settings: $(find HabitApp/Features/Settings -name "*.swift" 2>/dev/null | wc -l) files"

      - name: Find and list build products
        if: success()
        run: |
          echo "=== Build products ==="
          find ./DerivedData -name "*.app" -type d || echo "No apps found"
