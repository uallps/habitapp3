name: Build and Test HabitApp

on:
  push:
    branches: [ "categorias" ]
  pull_request:
    branches: [ "categorias" ]
  workflow_dispatch:

jobs:
  build:
    name: Build ${{ matrix.scheme }} for ${{ matrix.platform }}
    runs-on: macos-latest

    strategy:
      matrix:
        platform: [iOS, macOS]
        scheme: ["HabitApp"]
        include:
          - platform: iOS
            sdk: iphonesimulator
            artifact-name: ios-build
          - platform: macOS
            sdk: macosx
            destination: "platform=macOS"

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Show Xcode version
        run: xcodebuild -version

      - name: Show available SDKs
        run: xcodebuild -showsdks

      - name: Get latest iPhone simulator
        if: matrix.platform == 'iOS'
        id: get-simulator
        run: |
          DEVICE_INFO=$(xcrun simctl list devices available | grep -oE 'iPhone [^)]* \([^)]+\)' | tail -n 1)
          DEVICE_NAME=$(echo "$DEVICE_INFO" | sed -E 's/ \(.+\)//')
          DEVICE_RUNTIME=$(echo "$DEVICE_INFO" | grep -oE '\([^)]+\)' | tr -d '()')

          echo "DEVICE_NAME=$DEVICE_NAME" >> $GITHUB_ENV
          echo "DEVICE_RUNTIME=$DEVICE_RUNTIME" >> $GITHUB_ENV
          echo "Latest iPhone simulator: $DEVICE_NAME ($DEVICE_RUNTIME)"

      - name: Get latest iOS SDK
        if: matrix.platform == 'iOS'
        id: get-sdk
        run: |
          LATEST_SDK=$(xcodebuild -showsdks | grep -oE 'iphonesimulator[0-9.]+' | sort -V | tail -n1)
          echo "LATEST_SDK=$LATEST_SDK" >> $GITHUB_ENV
          echo "Latest iOS SDK: $LATEST_SDK"

      - name: Build for ${{ matrix.platform }}
        run: |
          if [ "${{ matrix.platform }}" == "iOS" ]; then
            xcodebuild clean build \
              -project HabitApp.xcodeproj \
              -scheme "${{ matrix.scheme }}" \
              -sdk "$LATEST_SDK" \
              -destination "platform=iOS Simulator,OS=$DEVICE_RUNTIME,name=$DEVICE_NAME" \
              -derivedDataPath ./DerivedData \
              CODE_SIGN_IDENTITY="" \
              CODE_SIGNING_REQUIRED=NO \
              CODE_SIGNING_ALLOWED=NO \
              -verbose
          else
            xcodebuild clean build \
              -project HabitApp.xcodeproj \
              -scheme "${{ matrix.scheme }}" \
              -sdk macosx \
              -destination "platform=macOS" \
              -derivedDataPath ./DerivedData \
              CODE_SIGN_IDENTITY="" \
              CODE_SIGNING_REQUIRED=NO \
              CODE_SIGNING_ALLOWED=NO \
              -verbose
          fi

      - name: Find and list build products
        if: success()
        run: |
          echo "=== ${{ matrix.platform }} ${{ matrix.scheme }} Build products ==="
          find ./DerivedData -name "*.app" -type d
          ls -R ./DerivedData/Build/Products/


      - name: Run Tests on iOS Simulator
        if: success() && matrix.platform == 'iOS'
        timeout-minutes: 10
        continue-on-error: true
        run: |
          mkdir -p screenshots
          
          # Boot simulator
          xcrun simctl boot "$DEVICE_NAME" || true
          xcrun simctl bootstatus "$DEVICE_NAME" -b
          
          # Find app
          APP_BUNDLE_ID="ual.HabitApp"
          APP_PATH=$(find ./DerivedData -name "HabitApp.app" -type d | head -n 1)
          
          if [ -z "$APP_PATH" ]; then
            echo "âŒ App not found"
            exit 1
          fi
          
          echo "âœ… Found app at: $APP_PATH"
          
          # Install and launch app
          xcrun simctl install booted "$APP_PATH"
          xcrun simctl launch booted $APP_BUNDLE_ID &
          sleep 5
          
          # Run UI tests, they'll create the screenshots
          echo "ðŸ“‹ Running XCTest cases..."

          xcodebuild test \
            -project HabitApp.xcodeproj \
            -scheme HabitApp \
            -sdk iphonesimulator \
            -destination 'platform=iOS Simulator,OS=latest,name=iPhone 16' \
            | tee result.log

          # Check if tests failed
          if grep -q "Test failed" result.log; then
            echo "âŒ Tests failed"
            exit 1
          else
            echo "âœ… Tests passed"
          fi
      - name: Upload Screenshots as Build Artifacts
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: screenshots
          path: screenshots/

      - name: Clean up screenshots folder
        run: |
          rm -rf ./screenshots

      - name: Code Quality Analysis
        run: |
          echo "ðŸ“Š Analyzing code quality..."
          cd HabitApp
          
          # Count Swift files
          SWIFT_FILES=$(find . -name "*.swift" | wc -l)
          echo "Total Swift files: $SWIFT_FILES"
          
          # Count lines of code
          LOC=$(find . -name "*.swift" -exec cat {} \; | wc -l)
          echo "Total lines of code: $LOC"
          
          # Find TODO and FIXME comments
          echo "\nðŸ” TODO items:"
          grep -r "TODO" --include="*.swift" . || echo "No TODOs found"
          
          echo "\nðŸ” FIXME items:"
          grep -r "FIXME" --include="*.swift" . || echo "No FIXMEs found"
          
          # Check for SwiftData models
          echo "\nðŸ“¦ SwiftData Models:"
          grep -r "@Model" --include="*.swift" . | cut -d: -f1 | sort -u
          
          # List all features
          echo "\nðŸŽ¯ Features implemented:"
          ls -d feature/*/ 2>/dev/null || echo "No features directory"

      - name: Archive build artifacts
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: build-iOS-HabitApp
          path: ./DerivedData/Build/Products/**/*.app

      - name: Upload Screenshots
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: screenshots
          path: screenshots/

      - name: Upload build report
        uses: actions/upload-artifact@v4
        with:
          name: build-report
          path: build-report.md

      - name: Upload build logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs
          path: ./DerivedData/Logs
