name: Build and Test HabitApp

on:
  push:
    branches: [  "core_8jan" ]
  pull_request:
    branches: [ "core_8jan" ]
  workflow_dispatch:

jobs:
  lint:
    name: SwiftLint & Code Quality
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install SwiftLint
        run: brew install swiftlint

      - name: Run SwiftLint
        run: swiftlint lint HabitApp --strict || true

      - name: Check for TODO/FIXME
        run: |
          echo "TODO items found:"
          grep -r "TODO" HabitApp --include="*.swift" | head -20 || echo "No TODOs"
          echo ""
          echo "FIXME items found:"
          grep -r "FIXME" HabitApp --include="*.swift" | head -20 || echo "No FIXMEs"

  build:
    name: Build and Test HabitApp
    runs-on: macos-latest
    needs: lint

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Show Xcode version
        run: xcodebuild -version

      - name: Show available SDKs
        run: xcodebuild -showsdks

      - name: Build for iOS Simulator
        run: |
          xcodebuild clean build \
            -project HabitApp.xcodeproj \
            -scheme HabitApp \
            -sdk iphonesimulator \
            -destination 'platform=iOS Simulator,name=iPhone 16' \
            -derivedDataPath ./DerivedData \
            IPHONEOS_DEPLOYMENT_TARGET=18.0 \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO

      - name: Build for macOS
        run: |
          xcodebuild clean build \
            -project HabitApp.xcodeproj \
            -scheme HabitApp \
            -sdk macosx \
            -destination 'platform=macOS' \
            -derivedDataPath ./DerivedData \
            MACOSX_DEPLOYMENT_TARGET=15.0 \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO
        continue-on-error: true

      - name: Run Unit Tests
        run: |
          xcodebuild test \
            -project HabitApp.xcodeproj \
            -scheme HabitApp \
            -sdk iphonesimulator \
            -destination 'platform=iOS Simulator,name=iPhone 16' \
            -derivedDataPath ./DerivedData \
            -testPlan HabitAppUnitTestsMacOS \
            IPHONEOS_DEPLOYMENT_TARGET=18.0 \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            | xcpretty || true
        continue-on-error: true

      - name: Test Results Summary
        if: always()
        run: |
          echo "Test Results:"
          find ./DerivedData -name "*.xcresult" -type d || echo "No test results found"
          
          # Extract test summary if available
          XCRESULT=$(find ./DerivedData -name "*.xcresult" -type d | head -n 1)
          if [ ! -z "$XCRESULT" ]; then
            xcrun xcresulttool get --path "$XCRESULT" --format json > test-results.json || true
            echo "Test results exported"
          fi

      - name: Code Quality Metrics
        run: |
          echo "Code Quality Report"
          echo "====================="
          SWIFT_FILES=$(find HabitApp -name "*.swift" -type f | wc -l)
          LOC=$(find HabitApp -name "*.swift" -type f -exec cat {} \; | wc -l)
          
          echo "Swift Files: $SWIFT_FILES"
          echo "Lines of Code: $LOC"
          echo "Avg lines per file: $((LOC / SWIFT_FILES))"
          
          echo ""
          echo "Architecture:"
          find HabitApp -type d -maxdepth 2 | grep -E "(Core|Features|Infraestructure|Application)" | sort
          
          echo ""
          echo "Feature Breakdown:"
          echo "Goals: $(find HabitApp/Features/Goals -name "*.swift" 2>/dev/null | wc -l) files"
          echo "DailyNotes: $(find HabitApp/Features/DailyNotes -name "*.swift" 2>/dev/null | wc -l) files"
          echo "Categories: $(find HabitApp/Features/Categories -name "*.swift" 2>/dev/null | wc -l) files"
          echo "Statistics: $(find HabitApp/Features/Statistics -name "*.swift" 2>/dev/null | wc -l) files"
          echo "Settings: $(find HabitApp/Features/Settings -name "*.swift" 2>/dev/null | wc -l) files"

      - name: Find and list build products
        if: success()
        run: |
          echo "=== Build products ==="
          find ./DerivedData -name "*.app" -type d || echo "No apps found"
          ls -R ./DerivedData/Build/Products/ || true

      - name: Boot simulator and launch app
        if: success()
        timeout-minutes: 10
        continue-on-error: true
        run: |
          mkdir -p screenshots
          
          # Boot simulator
          DEVICE_NAME="iPhone 16"
          xcrun simctl boot "$DEVICE_NAME" || true
          xcrun simctl bootstatus "$DEVICE_NAME" -b
          
          # Find app
          APP_BUNDLE_ID="ual.HabitApp"
          APP_PATH=$(find ./DerivedData -name "HabitApp.app" -type d | head -n 1)
          
          if [ -z "$APP_PATH" ]; then
            echo "App not found"
            exit 1
          fi
          
          echo "Found app at: $APP_PATH"
          
          # Install and launch app
          xcrun simctl install booted "$APP_PATH"
          xcrun simctl launch booted $APP_BUNDLE_ID &
          sleep 5
          
          # Take screenshots quickly
          echo "Taking screenshots..."
          xcrun simctl io booted screenshot screenshots/01-launch.png || true
          sleep 1
          xcrun simctl io booted screenshot screenshots/02-app.png || true
          sleep 1
          xcrun simctl io booted screenshot screenshots/03-app.png || true
          sleep 1
          xcrun simctl io booted screenshot screenshots/04-app.png || true
          
          echo "Screenshots captured"
          ls -la screenshots

      - name: Archive build artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: ./DerivedData/Build/Products/**/*.app
          if-no-files-found: warn

      - name: Upload screenshots
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: app-screenshots
          path: screenshots
          if-no-files-found: warn

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            test-results.json
            ./DerivedData/Logs/Test/*.xcresult
          if-no-files-found: warn

      - name: Generate Build Summary
        run: |
          cat > build-summary.txt << 'EOF'
          HabitApp Build Summary
          ======================
          Date: $(date)
          Branch: ${{ github.ref_name }}
          Commit: ${{ github.sha }}
          
          Features Implemented:
          - Habits Management (MVVM + SwiftData persistence)
          - Daily Notes (Date-based organization)
          - Streaks Tracking (Animation + Badges)
          - Goals & Milestones (Progress tracking with deadlines)
          - Categories System (Nested subcategories support)
          - Addictions Management (Independent feature toggle)
          - Statistics (Weekly/Daily/Per-Habit views with charts)
          - Reminders & Notifications (UNUserNotificationCenter)
          - Plugin Architecture (Extensible modular design)
          - UserPreferences (Dynamic theming with accent colors)
          - Cross-platform (iOS 18.0+ and macOS support)
          
          Tests:
          - Daily Notes unit tests
          - Goals & Milestones tests
          - Categories nesting tests
          
          Architecture:
          - MVVM pattern with SwiftData
          - StorageProvider abstraction layer
          - Feature-based folder structure
          - Dependency injection via AppConfig
          
          Build Status: Complete
          EOF
          cat build-summary.txt

      - name: Upload build summary
        uses: actions/upload-artifact@v4
        with:
          name: build-summary
          path: build-summary.txt

      - name: Upload build logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs
          path: ./DerivedData/Logs
