name: Build and Test HabitApp

on:
  push:
    branches: [ "franco" ]
  pull_request:
    branches: [ "franco" ]
  workflow_dispatch:

jobs:
  build:
    name: Build HabitApp for iOS
    runs-on: macos-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Show Xcode version
        run: xcodebuild -version

      - name: Show available SDKs
        run: xcodebuild -showsdks

      - name: Build for iOS
        run: |
          xcodebuild clean build \
            -project HabitApp.xcodeproj \
            -scheme HabitApp \
            -sdk iphonesimulator \
            -destination 'platform=iOS Simulator,OS=latest,name=iPhone 16' \
            -derivedDataPath ./DerivedData \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO

      - name: Find and list build products
        if: success()
        run: |
          echo "=== iOS Build products ==="
          find ./DerivedData -name "*.app" -type d
          ls -R ./DerivedData/Build/Products/

      - name: Boot simulator and launch app
        if: success()
        timeout-minutes: 10
        continue-on-error: true
        run: |
          mkdir -p screenshots
          
          # Boot simulator
          DEVICE_NAME="iPhone 16"
          xcrun simctl boot "$DEVICE_NAME" || true
          xcrun simctl bootstatus "$DEVICE_NAME" -b
          
          # Find app
          APP_BUNDLE_ID="ual.HabitApp"
          APP_PATH=$(find ./DerivedData -name "HabitApp.app" -type d | head -n 1)
          
          if [ -z "$APP_PATH" ]; then
            echo "âŒ App not found"
            exit 1
          fi
          
          echo "âœ… Found app at: $APP_PATH"
          
          # Install and launch app
          xcrun simctl install booted "$APP_PATH"
          xcrun simctl launch booted $APP_BUNDLE_ID &
          sleep 5
          
          # Take screenshots quickly
          echo "ðŸ“¸ Taking screenshots..."
          xcrun simctl io booted screenshot screenshots/01-launch.png || true
          sleep 1
          xcrun simctl io booted screenshot screenshots/02-app.png || true
          sleep 1
          xcrun simctl io booted screenshot screenshots/03-app.png || true
          sleep 1
          xcrun simctl io booted screenshot screenshots/04-app.png || true
          
          echo "âœ… Screenshots captured"
          ls -la screenshots

      - name: Code Quality Analysis
        run: |
          echo "ðŸ“Š Analyzing code quality..."
          cd HabitApp
          
          # Count Swift files
          SWIFT_FILES=$(find . -name "*.swift" | wc -l)
          echo "Total Swift files: $SWIFT_FILES"
          
          # Count lines of code
          LOC=$(find . -name "*.swift" -exec cat {} \; | wc -l)
          echo "Total lines of code: $LOC"
          
          # Find TODO and FIXME comments
          echo "\nðŸ” TODO items:"
          grep -r "TODO" --include="*.swift" . || echo "No TODOs found"
          
          echo "\nðŸ” FIXME items:"
          grep -r "FIXME" --include="*.swift" . || echo "No FIXMEs found"
          
          # Check for SwiftData models
          echo "\nðŸ“¦ SwiftData Models:"
          grep -r "@Model" --include="*.swift" . | cut -d: -f1 | sort -u
          
          # List all features
          echo "\nðŸŽ¯ Features implemented:"
          ls -d feature/*/ 2>/dev/null || echo "No features directory"

      - name: Archive build artifacts
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: build-iOS-HabitApp
          path: ./DerivedData/Build/Products/**/*.app

      - name: Upload screenshots
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: app-demo
          path: screenshots
          if-no-files-found: warn

      - name: Generate Build Report
        run: |
          echo "# HabitApp Build Report" > build-report.md
          echo "" >> build-report.md
          echo "## Build Information" >> build-report.md
          echo "- Date: $(date)" >> build-report.md
          echo "- Branch: ${{ github.ref_name }}" >> build-report.md
          echo "- Commit: ${{ github.sha }}" >> build-report.md
          echo "" >> build-report.md
          echo "## Features Implemented" >> build-report.md
          echo "- âœ… Habits Management" >> build-report.md
          echo "- âœ… Daily Notes" >> build-report.md
          echo "- âœ… Streaks Tracking" >> build-report.md
          echo "- âœ… Goals & Milestones" >> build-report.md
          echo "" >> build-report.md
          echo "## Build Status" >> build-report.md
          echo "- âœ… iOS Build: Success" >> build-report.md
          echo "- âœ… App Demo: 4 screenshots" >> build-report.md
          cat build-report.md
          
      - name: Upload build report
        uses: actions/upload-artifact@v4
        with:
          name: build-report
          path: build-report.md

      - name: Upload build logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs
          path: ./DerivedData/Logs
