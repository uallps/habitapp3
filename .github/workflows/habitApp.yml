name: Build and Test HabitApp

on:
  push:
    branches: [ "juanjo2", "main" ]
  pull_request:
    branches: [ "juanjo2", "main" ]
  workflow_dispatch:

jobs:
  lint:
    name: SwiftLint & Code Quality
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install SwiftLint
        run: brew install swiftlint

      - name: Run SwiftLint
        run: swiftlint lint HabitApp --strict || true

      - name: Check for TODO/FIXME
        run: |
          echo "ðŸ“ TODO items found:"
          grep -r "TODO" HabitApp --include="*.swift" | head -20 || echo "No TODOs"
          echo ""
          echo "ðŸ”§ FIXME items found:"
          grep -r "FIXME" HabitApp --include="*.swift" | head -20 || echo "No FIXMEs"

  build-ios:
    name: Build and Test iOS
    runs-on: macos-latest
    needs: lint
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Show Xcode version
        run: xcodebuild -version

      - name: Show available SDKs
        run: xcodebuild -showsdks

      - name: Build for iOS Simulator
        run: |
          xcodebuild clean build \
            -project HabitApp.xcodeproj \
            -scheme HabitApp \
            -sdk iphonesimulator \
            -destination 'generic/platform=iOS' \
            -derivedDataPath ./DerivedData \
            IPHONEOS_DEPLOYMENT_TARGET=18.0 \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO 2>&1 | tee ios-build.log
        continue-on-error: true

      - name: Show Build Errors
        if: always()
        run: |
          echo "ðŸ“‹ iOS Build Results:"
          if grep -q "error:" ios-build.log; then
            echo "âŒ Compilation errors found:"
            grep -A 2 "error:" ios-build.log | head -50
          else
            echo "âœ… Build completed successfully"
          fi

      - name: Run Unit Tests (latest iOS simulator)
        run: |
          set -e
          echo "ðŸ” Detecting latest iOS simulator..."

          DEVICE_ID=$(
            xcrun simctl list devices available -j |
            jq -r '
              .devices
              | to_entries
              | map(select(.key | test("iOS")))
              | map(.value[])
              | map(select(.isAvailable == true))
              | sort_by(.runtime)
              | .[-1].udid
            '
          )

          echo "ðŸ“± Using simulator UDID: $DEVICE_ID"

          xcodebuild test \
            -project HabitApp.xcodeproj \
            -scheme HabitApp \
            -destination "platform=iOS Simulator,id=$DEVICE_ID" \
            -derivedDataPath ./DerivedData \
            IPHONEOS_DEPLOYMENT_TARGET=18.0 \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            | xcpretty
        continue-on-error: true

      - name: Test Results Summary
        if: always()
        run: |
          echo "ðŸ“Š Test Results:"
          find ./DerivedData -name "*.xcresult" -type d || echo "No test results found"

          XCRESULT=$(find ./DerivedData -name "*.xcresult" -type d | head -n 1)
          if [ ! -z "$XCRESULT" ]; then
            xcrun xcresulttool get --path "$XCRESULT" --format json > test-results.json || true
            echo "âœ… Test results exported"
          fi

      - name: Find and list build products
        if: success()
        run: |
          echo "=== iOS Build products ==="
          find ./DerivedData -name "*.app" -type d || echo "No apps found"

      - name: Upload iOS Build Logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: ios-build-logs
          path: |
            ios-build.log
            ./DerivedData/Logs

  build-macos:
    name: Build and Test macOS
    runs-on: macos-latest
    needs: lint
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Show Xcode version
        run: xcodebuild -version

      - name: Build for macOS
        run: |
          xcodebuild clean build \
            -project HabitApp.xcodeproj \
            -scheme HabitApp \
            -sdk macosx \
            -destination 'platform=macOS' \
            -derivedDataPath ./DerivedData \
            MACOSX_DEPLOYMENT_TARGET=15.0 \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO 2>&1 | tee macos-build.log
        continue-on-error: true

      - name: Show Build Errors
        if: always()
        run: |
          echo "ðŸ“‹ macOS Build Results:"
          if grep -q "error:" macos-build.log; then
            echo "âŒ Compilation errors found:"
            grep -A 2 "error:" macos-build.log | head -50
          else
            echo "âœ… Build completed successfully"
          fi

      - name: Run macOS Unit Tests
        run: |
          xcodebuild test \
            -project HabitApp.xcodeproj \
            -scheme HabitApp \
            -sdk macosx \
            -destination 'platform=macOS' \
            -derivedDataPath ./DerivedData \
            MACOSX_DEPLOYMENT_TARGET=15.0 \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            | xcpretty
        continue-on-error: true

      - name: Find and list build products
        if: success()
        run: |
          echo "=== macOS Build products ==="
          find ./DerivedData -name "*.app" -type d || echo "No apps found"

      - name: Upload macOS Build Logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: macos-build-logs
          path: |
            macos-build.log
            ./DerivedData/Logs

  metrics:
    name: Code Quality Metrics
    runs-on: ubuntu-latest
    needs: [build-ios, build-macos]
    if: always()
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Code Quality Report
        run: |
          echo "# ðŸ“Š Code Quality Report" > metrics-report.md
          echo "" >> metrics-report.md
          echo "## ðŸ“ˆ Statistics" >> metrics-report.md
          
          SWIFT_FILES=$(find HabitApp -name "*.swift" -type f | wc -l)
          LOC=$(find HabitApp -name "*.swift" -type f -exec cat {} \; | wc -l)
          AVG_LOC=$((LOC / SWIFT_FILES))
          
          echo "- **Swift Files**: $SWIFT_FILES" >> metrics-report.md
          echo "- **Lines of Code**: $LOC" >> metrics-report.md
          echo "- **Avg lines per file**: $AVG_LOC" >> metrics-report.md
          echo "" >> metrics-report.md
          
          echo "## ðŸ—ï¸ Architecture" >> metrics-report.md
          echo "\`\`\`" >> metrics-report.md
          find HabitApp -type d -maxdepth 2 | grep -E "(Core|Features|Infraestructure|Application)" | sort >> metrics-report.md
          echo "\`\`\`" >> metrics-report.md
          echo "" >> metrics-report.md
          
          echo "## ðŸŽ¯ Feature Breakdown" >> metrics-report.md
          echo "" >> metrics-report.md
          ACHIEVEMENTS=$(find HabitApp/Features/Achievements -name "*.swift" 2>/dev/null | wc -l)
          STATISTICS=$(find HabitApp/Features/Statistics -name "*.swift" 2>/dev/null | wc -l)
          SETTINGS=$(find HabitApp/Features/Settings -name "*.swift" 2>/dev/null | wc -l)
          CORE=$(find HabitApp/Core -name "*.swift" 2>/dev/null | wc -l)
          
          echo "| Feature | Files |" >> metrics-report.md
          echo "|---------|-------|" >> metrics-report.md
          echo "| Achievements | $ACHIEVEMENTS |" >> metrics-report.md
          echo "| Statistics | $STATISTICS |" >> metrics-report.md
          echo "| Settings | $SETTINGS |" >> metrics-report.md
          echo "| Core | $CORE |" >> metrics-report.md
          echo "" >> metrics-report.md
          
          echo "## ðŸ“¦ SwiftData Models" >> metrics-report.md
          echo "" >> metrics-report.md
          echo "\`\`\`" >> metrics-report.md
          grep -r "@Model" --include="*.swift" HabitApp/ 2>/dev/null | cut -d: -f1 | sort -u | xargs -I {} basename {} >> metrics-report.md || echo "None found" >> metrics-report.md
          echo "\`\`\`" >> metrics-report.md
          
          cat metrics-report.md

      - name: Upload Metrics Report
        uses: actions/upload-artifact@v4
        with:
          name: metrics-report
          path: metrics-report.md

  report:
    name: Generate Build Report
    runs-on: ubuntu-latest
    needs: [lint, build-ios, build-macos, metrics]
    if: always()
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Generate Report
        run: |
          echo "# ðŸŽ¯ HabitApp Build Report" > build-report.md
          echo "" >> build-report.md
          echo "## ðŸ“Š Build Information" >> build-report.md
          echo "- **Date**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> build-report.md
          echo "- **Branch**: \`${{ github.ref_name }}\`" >> build-report.md
          echo "- **Commit**: \`${{ github.sha }}\`" >> build-report.md
          echo "- **Trigger**: ${{ github.event_name }}" >> build-report.md
          echo "" >> build-report.md
          
          echo "## ðŸ—ï¸ Build Results" >> build-report.md
          echo "" >> build-report.md
          
          if [ "${{ needs.lint.result }}" == "success" ]; then
            echo "- âœ… **Lint**: Passed" >> build-report.md
          else
            echo "- âš ï¸  **Lint**: ${{ needs.lint.result }}" >> build-report.md
          fi
          
          if [ "${{ needs.build-ios.result }}" == "success" ]; then
            echo "- âœ… **iOS Build**: Success" >> build-report.md
          else
            echo "- âŒ **iOS Build**: Failed" >> build-report.md
          fi
          
          if [ "${{ needs.build-macos.result }}" == "success" ]; then
            echo "- âœ… **macOS Build**: Success" >> build-report.md
          else
            echo "- âŒ **macOS Build**: Failed" >> build-report.md
          fi
          
          if [ "${{ needs.metrics.result }}" == "success" ]; then
            echo "- âœ… **Metrics**: Collected" >> build-report.md
          else
            echo "- âš ï¸  **Metrics**: ${{ needs.metrics.result }}" >> build-report.md
          fi
          
          echo "" >> build-report.md
          echo "## âœ¨ Features Implemented" >> build-report.md
          echo "" >> build-report.md
          echo "### Core Features" >> build-report.md
          echo "- âœ… Habits Management (CRUD)" >> build-report.md
          echo "- âœ… Weekly Schedule & Frequency" >> build-report.md
          echo "- âœ… Priority Levels" >> build-report.md
          echo "- âœ… Daily Completion Tracking" >> build-report.md
          echo "- âœ… Streak Calculation" >> build-report.md
          echo "- âœ… Custom Emojis" >> build-report.md
          echo "" >> build-report.md
          echo "### Plugin System" >> build-report.md
          echo "- âœ… Statistics Feature (Plugin)" >> build-report.md
          echo "- âœ… Achievements Feature (Plugin)" >> build-report.md
          echo "- âœ… Modular Architecture" >> build-report.md
          echo "" >> build-report.md
          echo "### Architecture" >> build-report.md
          echo "- âœ… MVVM Pattern" >> build-report.md
          echo "- âœ… SwiftData Persistence" >> build-report.md
          echo "- âœ… SwiftUI Declarative UI" >> build-report.md
          echo "- âœ… iOS & macOS Support" >> build-report.md
          
          cat build-report.md

      - name: Upload Build Report
        uses: actions/upload-artifact@v4
        with:
          name: build-report
          path: build-report.md
