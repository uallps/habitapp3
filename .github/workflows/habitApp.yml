name: Build and Test HabitApp

on:
  push:
    branches: [ "franco" ]
  pull_request:
    branches: [ "franco" ]

jobs:
  build:
    runs-on: macos-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Select Xcode version
        run: sudo xcode-select -s /Applications/Xcode.app/Contents/Developer

      - name: Boot iPhone simulator
        run: |
          DEVICE_NAME="iPhone 16"
          echo "Booting device: $DEVICE_NAME"
          xcrun simctl boot "$DEVICE_NAME" || true
          xcrun simctl bootstatus "$DEVICE_NAME" -b
          echo "DEVICE_NAME=$DEVICE_NAME" >> $GITHUB_ENV

      - name: Build and Test HabitApp for iOS
        run: |
          cd HabitApp
          xcodebuild \
            -project HabitApp.xcodeproj \
            -scheme HabitApp \
            -sdk iphonesimulator \
            -destination "platform=iOS Simulator,name=$DEVICE_NAME,OS=latest" \
            -derivedDataPath build \
            -configuration Debug \
            clean build test | xcpretty

      - name: Build for macOS
        run: |
          cd HabitApp
          xcodebuild \
            -project HabitApp.xcodeproj \
            -scheme HabitApp \
            -sdk macosx \
            -destination "platform=macOS" \
            -derivedDataPath build-macos \
            -configuration Debug \
            clean build | xcpretty

      - name: Launch iOS app and test features
        run: |
          cd HabitApp
          mkdir -p screenshots
          APP_BUNDLE_ID="com.ual.HabitApp"
          APP_PATH=$(find build -name "HabitApp.app" -path "*/Debug-iphonesimulator/*" | head -n 1)
          
          if [ -z "$APP_PATH" ]; then
            echo "âŒ App bundle not found"
            echo "Searching in build directory:"
            find build -name "*.app" || echo "No .app bundles found"
            exit 1
          fi
          
          echo "Found app at: $APP_PATH"
          xcrun simctl install booted "$APP_PATH"
          xcrun simctl launch booted $APP_BUNDLE_ID || true
          sleep 5
          
          # Test app launch
          if xcrun simctl list | grep -q "$APP_BUNDLE_ID"; then
            echo "âœ… App launched successfully"
          else
            echo "âŒ App failed to launch"
            exit 1
          fi

      - name: Run UI Tests and Automation
        run: |
          cd HabitApp
          APP_BUNDLE_ID="com.ual.HabitApp"
          
          # Test 1: Capture initial state
          xcrun simctl io booted screenshot screenshots/01-launch.png
          echo "âœ… Screenshot 1: App launch"
          
          # Test 2: Simulate tap on Habits tab
          xcrun simctl ui booted tap 50 800
          sleep 1
          xcrun simctl io booted screenshot screenshots/02-habits-tab.png
          echo "âœ… Screenshot 2: Habits tab"
          
          # Test 3: Simulate tap on Notes tab
          xcrun simctl ui booted tap 150 800
          sleep 1
          xcrun simctl io booted screenshot screenshots/03-notes-tab.png
          echo "âœ… Screenshot 3: Notes tab"
          
          # Test 4: Simulate tap on Goals tab
          xcrun simctl ui booted tap 250 800
          sleep 1
          xcrun simctl io booted screenshot screenshots/04-goals-tab.png
          echo "âœ… Screenshot 4: Goals tab"
          
          echo "ðŸ“¸ All screenshots captured"
          ls -la screenshots

      - name: Code Quality Analysis
        run: |
          cd HabitApp
          echo "ðŸ“Š Analyzing code quality..."
          
          # Count Swift files
          SWIFT_FILES=$(find . -name "*.swift" | wc -l)
          echo "Total Swift files: $SWIFT_FILES"
          
          # Count lines of code
          LOC=$(find . -name "*.swift" -exec cat {} \; | wc -l)
          echo "Total lines of code: $LOC"
          
          # Find TODO and FIXME comments
          echo "\nðŸ” TODO items:"
          grep -r "TODO" --include="*.swift" . || echo "No TODOs found"
          
          echo "\nðŸ” FIXME items:"
          grep -r "FIXME" --include="*.swift" . || echo "No FIXMEs found"
          
          # Check for SwiftData models
          echo "\nðŸ“¦ SwiftData Models:"
          grep -r "@Model" --include="*.swift" . | cut -d: -f1 | sort -u
          
          # List all features
          echo "\nðŸŽ¯ Features implemented:"
          ls -d feature/*/ 2>/dev/null || echo "No features directory"

      - name: Verify build artifacts
        run: |
          cd HabitApp
          echo "iOS Build artifacts:"
          find build -name "*.app" -type d || echo "No iOS artifacts found"
          echo "macOS Build artifacts:"
          find build-macos -name "*.app" -type d || echo "No macOS artifacts found"
          
          # Check app size
          if [ -d "build" ]; then
            APP_SIZE=$(du -sh build | cut -f1)
            echo "iOS Build size: $APP_SIZE"
          fi
          
          if [ -d "build-macos" ]; then
            MACOS_SIZE=$(du -sh build-macos | cut -f1)
            echo "macOS Build size: $MACOS_SIZE"
          fi

      - name: Generate Test Report
        run: |
          cd HabitApp
          echo "# HabitApp Test Report" > test-report.md
          echo "" >> test-report.md
          echo "## Build Information" >> test-report.md
          echo "- Date: $(date)" >> test-report.md
          echo "- Branch: ${{ github.ref_name }}" >> test-report.md
          echo "- Commit: ${{ github.sha }}" >> test-report.md
          echo "" >> test-report.md
          echo "## Features Tested" >> test-report.md
          echo "- âœ… Habits Management" >> test-report.md
          echo "- âœ… Daily Notes" >> test-report.md
          echo "- âœ… Goals & Milestones" >> test-report.md
          echo "" >> test-report.md
          echo "## Screenshots" >> test-report.md
          echo "4 screenshots captured successfully" >> test-report.md
          cat test-report.md

      - name: Upload screenshots as artifact
        uses: actions/upload-artifact@v4
        with:
          name: iOS-screenshots
          path: HabitApp/screenshots
          
      - name: Upload test report
        uses: actions/upload-artifact@v4
        with:
          name: test-report
          path: HabitApp/test-report.md

      - name: Upload build logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs
          path: |
            HabitApp/build/Logs
            HabitApp/build-macos/Logs
